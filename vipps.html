<!doctype html>
<html lang="nb">
<head>
  <meta charset="utf-8" />
  <title>Vipps – FjOlsenbanden</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Støtt FjOlsenbanden med Vipps." />
  <link rel="stylesheet" href="/styles.css" />
</head>

<body>
  <header class="top-nav">
    <div class="container nav-inner">
      <div class="logo">
        <a href="/"><img src="/img/logo//Liggende-M.png" alt="FjOlsenbanden logo" /></a>
      </div>
      <nav class="nav-links">
        <a href="/#about">Om</a>
        <a href="/#community">Community</a>
        <a href="/#kontakt">Kontakt</a>
      </nav>
      <div class="nav-actions">
        <a href="/#membership" class="btn btn-primary small">Bli medlem</a>
      </div>
    </div>
  </header>

  <main>
    <section class="section">
      <div class="container">
        <h2>Vipps <span class="highlight">støtte</span></h2>
        <p class="subtitle">
          Her kan du opprette en fast støtte (abonnement) eller gjøre en engangsbetaling.
        </p>

        <div class="services-grid">
          <!-- Engang -->
          <div class="card service">
            <h3>Engangsbetaling</h3>
            <p>Send valgfritt beløp som engangsstøtte.</p>

            <label style="display:block; margin: 0.75rem 0 0.35rem; color: var(--muted); font-weight: 600;">
              Beløp (NOK)
            </label>
            <input id="oneTimeAmount" type="number" min="1" step="1" value="50" />

            <div style="margin-top: 1rem;">
              <button id="btnOneTime" class="btn btn-primary">Betal med Vipps</button>
            </div>

            <p id="oneTimeStatus" class="vipps-front-status"></p>
          </div>

          <!-- Fast -->
          <div class="card service">
            <h3>Fast betaling</h3>
            <p>Opprett en månedlig støtteavtale (Vipps Recurring).</p>

            <label style="display:block; margin: 0.75rem 0 0.35rem; color: var(--muted); font-weight: 600;">
              Beløp per måned (NOK)
            </label>
            <input id="monthlyAmount" type="number" min="1" step="1" value="49" />

            <div style="margin-top: 1rem; display:flex; gap: 0.75rem; flex-wrap: wrap;">
              <button id="btnCreateAgreement" class="btn btn-secondary">Opprett avtale</button>
              <a class="btn btn-ghost" href="/vilkar.html">Vilkår</a>
            </div>

            <p id="agreementStatus" class="vipps-front-status"></p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container footer-bottom">
      <p>© 2025 Fjolsenbanden v/Fair Share Invest AS – Org.nr. 926 963 023</p>
      <a href="/personvernerklaering.html" class="footer-bottom-link">Personvern</a>
    </div>
  </footer>

  <script>
    const apiBase = "/vipps/api";

    function setText(id, msg) {
      const el = document.getElementById(id);
      if (el) el.textContent = msg || "";
    }

    async function postJSON(url, body) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Accept": "application/json" },
        body: JSON.stringify(body || {})
      });

      const text = await res.text();
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch (e) {}

      if (!res.ok) {
        const errMsg = data?.message || data?.error || text || ("HTTP " + res.status);
        throw new Error(errMsg);
      }
      return data;
    }

    // Engang (checkout/ecom) - du kan koble dette til Checkout-løsningen din senere.
    document.getElementById("btnOneTime")?.addEventListener("click", async () => {
      setText("oneTimeStatus", "Sender...");
      try {
        const amount = parseInt(document.getElementById("oneTimeAmount").value || "0", 10);
        const data = await postJSON(`${apiBase}/create_one_time_payment.php`, { amount });
        // forventer { redirectUrl: "https://..." }
        if (data?.redirectUrl) {
          window.location.href = data.redirectUrl;
          return;
        }
        setText("oneTimeStatus", "OK, men mangler redirectUrl fra server.");
      } catch (e) {
        setText("oneTimeStatus", "Feil: " + e.message);
      }
    });

    // Fast betaling (Recurring agreement)
    document.getElementById("btnCreateAgreement")?.addEventListener("click", async () => {
      setText("agreementStatus", "Oppretter avtale...");
      try {
        const amount = parseInt(document.getElementById("monthlyAmount").value || "0", 10);
        const data = await postJSON(`${apiBase}/create_agreement.php`, { amount });

        // ofte får du en url kunden må godkjenne i Vipps-appen / redirect
        if (data?.vippsConfirmationUrl) {
          window.location.href = data.vippsConfirmationUrl;
          return;
        }
        if (data?.redirectUrl) {
          window.location.href = data.redirectUrl;
          return;
        }
        setText("agreementStatus", "Avtale opprettet, men mangler redirect/confirmation-url fra server.");
      } catch (e) {
        setText("agreementStatus", "Feil: " + e.message);
      }
    });
  </script>
</body>
</html>
